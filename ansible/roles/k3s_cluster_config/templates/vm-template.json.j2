{
  "name": "k3s-{{ node_type }}-{{ inventory_hostname }}",
  "description": "K3S {{ node_type | title }} Node - {{ inventory_hostname }}",
  "vmid": {{ vm_id | default(ansible_play_hosts.index(inventory_hostname) + 1000) }},
  "cores": {{ vm_config.vcpus | default(2) }},
  "memory": {{ vm_config.memory | default(4096) }},
  "sockets": 1,
  "numa": false,
  "kvm": true,
  "hotplug": "disk,network,usb",
  "ostype": "l26",
  "arch": "x86_64",
  "boot": "order=scsi0;net0",
  "bootdisk": "scsi0",
  "scsihw": "virtio-scsi-pci",
  "ide2": "{{ iso_storage | default('local') }}:iso/{{ os_template | default('ubuntu-22.04-server-cloudimg-amd64.img') }},media=cdrom",
  "scsi0": "{{ vm_storage | default('local-lvm') }}:{{ vm_config.disk | default(50) }},format=qcow2,iothread=1,discard=on",
  "net0": "virtio,bridge={{ network_bridge | default('vmbr0') }}{% if network.vlan_id is defined %},tag={{ network.vlan_id }}{% endif %},firewall=1",
  "ipconfig0": "ip={{ node_ip | default('dhcp') }}/{{ network_mask | default('24') }},gw={{ network_gateway | default('192.168.1.1') }}",
  "nameserver": "{{ dns_servers | default('8.8.8.8,8.8.4.4') }}",
  "searchdomain": "{{ search_domain | default('local') }}",
  "ciuser": "{{ cloud_init_user | default('k3s') }}",
  "cipassword": "{{ cloud_init_password | default('k3s123') }}",
  "sshkeys": "{{ ssh_public_keys | default('') | urlencode }}",
  "cicustom": "user={{ cloud_init_storage | default('local') }}:snippets/k3s-{{ node_type }}-user-data.yml",
  "tags": "k3s;{{ node_type }};{{ site_name | default('cluster') }}",
  "protection": false,
  "template": false,
  "balloon": {{ (vm_config.memory * 0.5) | int }},
  "shares": 1000,
  "vcpus": {{ vm_config.vcpus | default(2) }},
  "cpulimit": 0,
  "cpuunits": 1024,
  "args": "-cpu host",
  {% if node_type == 'master' %}
  "startup": "order=1,up=30,down=60",
  {% else %}
  "startup": "order=2,up=45,down=60",
  {% endif %}
  "onboot": true,
  "agent": "enabled=1,fstrim_cloned_disks=1",
  "tablet": false,
  "migrate_downtime": 10,
  "migrate_speed": 512
}
